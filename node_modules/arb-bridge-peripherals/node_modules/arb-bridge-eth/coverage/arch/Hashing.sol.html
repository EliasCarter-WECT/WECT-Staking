<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for arch/Hashing.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">arch/</a> Hashing.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/52</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/45</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: Apache-2.0
&nbsp;
/*
 * Copyright 2019-2020, Offchain Labs, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
&nbsp;
pragma solidity ^0.6.11;
&nbsp;
import "./Value.sol";
&nbsp;
library Hashing {
    using Hashing for Value.Data;
    using Value for Value.CodePoint;
&nbsp;
<span class="fstat-no" title="function not covered" >    function keccak1(bytes32 b) internal pure returns (bytes32) {</span>
<span class="cstat-no" title="statement not covered" >        return keccak256(abi.encodePacked(b));</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function keccak2(bytes32 a, bytes32 b) internal pure returns (bytes32) {</span>
<span class="cstat-no" title="statement not covered" >        return keccak256(abi.encodePacked(a, b));</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function bytes32FromArray(</span>
        bytes memory arr,
        uint256 offset,
        uint256 arrLength
    ) internal pure returns (uint256) {
<span class="cstat-no" title="statement not covered" >        uint256 res = 0;</span>
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; 32; i++) {</span>
<span class="cstat-no" title="statement not covered" >            res = res &lt;&lt; 8</span>;
<span class="cstat-no" title="statement not covered" >            bytes1 b = arrLength &gt; offset + i ? arr[offset + i] : bytes1(0);</span>
<span class="cstat-no" title="statement not covered" >            res = res | uint256(uint8(b))</span>;
        }
<span class="cstat-no" title="statement not covered" >        return res;</span>
    }
&nbsp;
    /*
     * !! Note that dataLength must be a power of two !!
     *
     * If you have an arbitrary data length, you can round it up with roundUpToPow2.
     * The boolean return value tells if the data segment data[startOffset..startOffset+dataLength] only included zeroes.
     * If pack is true, the returned value is the merkle hash where trailing zeroes are ignored, that is,
     *   if h is the smallest height for which all data[startOffset+2**h..] are zero, merkle hash of data[startOffset..startOffset+2**h] is returned.
     * If all elements in the data segment are zero (and pack is true), keccak1(bytes32(0)) is returned.
     */
<span class="fstat-no" title="function not covered" >    function merkleRoot(</span>
        bytes memory data,
        uint256 rawDataLength,
        uint256 startOffset,
        uint256 dataLength,
        bool pack
    ) internal pure returns (bytes32, bool) {
<span class="cstat-no" title="statement not covered" >        if (dataLength &lt;= 32) {</span>
<span class="cstat-no" title="statement not covered" >            if (startOffset &gt;= rawDataLength) {</span>
<span class="cstat-no" title="statement not covered" >                return (keccak1(bytes32(0)), true);</span>
            }
<span class="cstat-no" title="statement not covered" >            bytes32 res = keccak1(bytes32(bytes32FromArray(data, startOffset, rawDataLength)));</span>
<span class="cstat-no" title="statement not covered" >            return (res, res == keccak1(bytes32(0)));</span>
        }
<span class="cstat-no" title="statement not covered" >        (bytes32 h2, bool zero2) =</span>
            merkleRoot(data, rawDataLength, startOffset + dataLength / 2, dataLength / 2, false);
<span class="cstat-no" title="statement not covered" >        if (zero2 &amp;&amp; pack) {</span>
<span class="cstat-no" title="statement not covered" >            return merkleRoot(data, rawDataLength, startOffset, dataLength / 2, pack);</span>
        }
<span class="cstat-no" title="statement not covered" >        (bytes32 h1, bool zero1) =</span>
            merkleRoot(data, rawDataLength, startOffset, dataLength / 2, false);
<span class="cstat-no" title="statement not covered" >        return (keccak2(h1, h2), zero1 &amp;&amp; zero2);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function roundUpToPow2(uint256 len) internal pure returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        if (len &lt;= 1) <span class="cstat-no" title="statement not covered" >return 1;</span></span>
        else <span class="cstat-no" title="statement not covered" >return 2 * roundUpToPow2((len + 1) / 2);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function bytesToBufferHash(</span>
        bytes memory buf,
        uint256 startOffset,
        uint256 length
    ) internal pure returns (bytes32) {
<span class="cstat-no" title="statement not covered" >        (bytes32 mhash, ) =</span>
            merkleRoot(buf, startOffset + length, startOffset, roundUpToPow2(length), true);
<span class="cstat-no" title="statement not covered" >        return keccak2(bytes32(uint256(123)), mhash);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function hashInt(uint256 val) internal pure returns (bytes32) {</span>
<span class="cstat-no" title="statement not covered" >        return keccak256(abi.encodePacked(val));</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function hashCodePoint(Value.CodePoint memory cp) internal pure returns (bytes32) {</span>
<span class="cstat-no" title="statement not covered" >        assert(cp.immediate.length &lt; 2)</span>;
<span class="cstat-no" title="statement not covered" >        if (cp.immediate.length == 0) {</span>
<span class="cstat-no" title="statement not covered" >            return</span>
                keccak256(abi.encodePacked(Value.codePointTypeCode(), cp.opcode, cp.nextCodePoint));
        }
<span class="cstat-no" title="statement not covered" >        return</span>
            keccak256(
                abi.encodePacked(
                    Value.codePointTypeCode(),
                    cp.opcode,
                    cp.immediate[0].hash(),
                    cp.nextCodePoint
                )
            );
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function hashTuplePreImage(bytes32 innerHash, uint256 valueSize)</span>
        internal
        pure
        returns (bytes32)
    {
<span class="cstat-no" title="statement not covered" >        return keccak256(abi.encodePacked(uint8(Value.tupleTypeCode()), innerHash, valueSize));</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function hash(Value.Data memory val) internal pure returns (bytes32) {</span>
<span class="cstat-no" title="statement not covered" >        if (val.typeCode == Value.intTypeCode()) {</span>
<span class="cstat-no" title="statement not covered" >            return hashInt(val.intVal);</span>
        } else <span class="cstat-no" title="statement not covered" >if (val.typeCode == Value.codePointTypeCode()) {</span>
<span class="cstat-no" title="statement not covered" >            return hashCodePoint(val.cpVal);</span>
        } else <span class="cstat-no" title="statement not covered" >if (val.typeCode == Value.tuplePreImageTypeCode()) {</span>
<span class="cstat-no" title="statement not covered" >            return hashTuplePreImage(bytes32(val.intVal), val.size);</span>
        } else <span class="cstat-no" title="statement not covered" >if (val.typeCode == Value.tupleTypeCode()) {</span>
<span class="cstat-no" title="statement not covered" >            Value.Data memory preImage = getTuplePreImage(val.tupleVal);</span>
<span class="cstat-no" title="statement not covered" >            return preImage.hash();</span>
        } else <span class="cstat-no" title="statement not covered" >if (val.typeCode == Value.hashOnlyTypeCode()) {</span>
<span class="cstat-no" title="statement not covered" >            return bytes32(val.intVal);</span>
        } else <span class="cstat-no" title="statement not covered" >if (val.typeCode == Value.bufferTypeCode()) {</span>
<span class="cstat-no" title="statement not covered" >            return keccak256(abi.encodePacked(uint256(123), val.bufferHash));</span>
        } else {
<span class="cstat-no" title="statement not covered" >            require(false, "Invalid type code")</span>;
        }
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function getTuplePreImage(Value.Data[] memory vals) internal pure returns (Value.Data memory) {</span>
<span class="cstat-no" title="statement not covered" >        require(vals.length &lt;= 8, "Invalid tuple length")</span>;
<span class="cstat-no" title="statement not covered" >        bytes32[] memory hashes = new bytes32[](vals.length);</span>
<span class="cstat-no" title="statement not covered" >        uint256 hashCount = hashes.length;</span>
<span class="cstat-no" title="statement not covered" >        uint256 size = 1;</span>
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; hashCount; i++) {</span>
<span class="cstat-no" title="statement not covered" >            hashes[i] = vals[i].hash()</span>;
<span class="cstat-no" title="statement not covered" >            size += vals[i].size</span>;
        }
<span class="cstat-no" title="statement not covered" >        bytes32 firstHash = keccak256(abi.encodePacked(uint8(hashes.length), hashes));</span>
<span class="cstat-no" title="statement not covered" >        return Value.newTuplePreImage(firstHash, size);</span>
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jul 26 2021 12:50:42 GMT+0100 (British Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
